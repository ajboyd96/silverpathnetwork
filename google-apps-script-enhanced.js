/**
 * Silver Path Network - Enhanced SMS Verification with Lead Capture
 * This Google Apps Script handles verification codes, email sending, and lead capture with quiz data
 * 
 * Setup Instructions:
 * 1. Open Google Apps Script (script.google.com)
 * 2. Create a new project and paste this code
 * 3. Deploy as web app with execute permissions for "Anyone"
 * 4. Update the URL in assessment-script.js
 */

// Configuration
const SPREADSHEET_ID = '1MZYgrMksEKzKksiXYf7B2dNnrzu9prScwbCZ0TWmIxc';
const CODES_SHEET_NAME = 'Sheet1'; // Sheet with verification codes  
const LEADS_SHEET_NAME = 'Lead Info'; // Sheet for lead information
const ADMIN_EMAIL = 'ajboyd96@gmail.com';

/**
 * Handle both GET and POST requests
 */
function doGet(e) {
  return ContentService
    .createTextOutput('Silver Path Network SMS Verification API is running')
    .setMimeType(ContentService.MimeType.TEXT);
}

function doPost(e) {
  try {
    console.log('Received POST request');
    console.log('Request parameters:', e.parameter);
    
    // Handle form submission (current method)
    const params = e.parameter;
    
    // Check if this is a verification code sending request
    if (params.firstName && params.lastName && params.email && params.phone) {
      return handleVerificationRequest(params);
    }
    
    // Handle resend requests
    if (params.resend === 'true') {
      return handleResendRequest(params);
    }
    
    return createFormResponse(false, 'Invalid request parameters');
    
  } catch (error) {
    console.error('Error in doPost:', error);
    return createFormResponse(false, 'Server error occurred');
  }
}

/**
 * Handle verification code request and lead capture
 */
function handleVerificationRequest(params) {
  try {
    const { firstName, lastName, email, phone, verificationCode } = params;
    
    // Use provided verification code, or generate one if not provided
    var code = verificationCode || Math.floor(100000 + Math.random() * 900000).toString();
    console.log('Using verification code:', code);
    
    // Normalize phone number - remove all non-digits and handle country code
    var cleanPhone = phone.replace(/\D/g, '');
    if (cleanPhone.length === 11 && cleanPhone.startsWith('1')) {
      cleanPhone = cleanPhone.substring(1);
    }
    console.log('Normalized phone:', cleanPhone);
    
    // Check if this is a resend request
    var isResend = params.resend === 'true';
    
    // Send detailed email to admin with text template
    var subject = 'Silver Path Network - ' + (isResend ? 'RESEND CODE' : 'New Lead') + ': ' + firstName + ' ' + lastName;
    var body = (isResend ? 'RESEND CODE request for existing lead:\n\n' : 'New lead verification request:\n\n');
    body += '=== TEXT MESSAGE TO SEND ===\n';
    body += 'Hi ' + firstName + ', Thank you for choosing Silver Path Network. Your code is ' + code + '\n\n';
    body += '=== LEAD INFORMATION ===\n';
    body += 'Name: ' + firstName + ' ' + lastName + '\n';
    body += 'Email: ' + email + '\n';
    body += 'Phone: ' + cleanPhone + '\n';
    body += 'Verification Code: ' + code + '\n';
    body += 'Request Type: ' + (isResend ? 'Resend Code' : 'New Lead') + '\n';
    body += 'Timestamp: ' + new Date().toLocaleString() + '\n\n';
    body += '=== INSTRUCTIONS ===\n';
    body += '1. Text the above message to the lead at their phone number\n';
    body += '2. They will enter this code on the website to verify\n';
    body += '3. Once verified, their complete information will be added to the Lead Info sheet\n\n';
    body += 'Generated by Silver Path Network System';
    
    // Send email notification
    GmailApp.sendEmail(ADMIN_EMAIL, subject, body);
    console.log('Email sent to admin with verification code');
    
    // Store lead information temporarily for when verification completes
    var leadData = {
      firstName: firstName,
      lastName: lastName,
      email: email,
      phone: cleanPhone,
      verificationCode: code,
      timestamp: new Date().toISOString(),
      verified: false
    };
    
    // Store in PropertiesService using phone as key
    PropertiesService.getScriptProperties().setProperty('lead_' + cleanPhone, JSON.stringify(leadData));
    console.log('Lead data stored for phone:', cleanPhone);
    
    return createFormResponse(true, 'Verification code sent successfully');
    
  } catch (error) {
    console.error('Error handling verification request:', error);
    return createFormResponse(false, 'Failed to send verification code');
  }
}

/**
 * Handle resend requests
 */
function handleResendRequest(params) {
  try {
    console.log('Handling resend request');
    return handleVerificationRequest(params);
  } catch (error) {
    console.error('Error handling resend request:', error);
    return createFormResponse(false, 'Failed to resend verification code');
  }
}

/**
 * Mark lead as verified and add to Lead Info sheet
 * This function is called from the frontend when verification succeeds
 */
function markLeadVerified(phone, quizAnswers) {
  try {
    console.log('Marking lead as verified for phone:', phone);
    
    // Get stored lead data
    var leadJson = PropertiesService.getScriptProperties().getProperty('lead_' + phone);
    if (!leadJson) {
      console.error('No lead data found for phone:', phone);
      return false;
    }
    
    var leadData = JSON.parse(leadJson);
    leadData.verified = true;
    leadData.verifiedAt = new Date().toISOString();
    leadData.quizAnswers = quizAnswers || {};
    
    // Add to Lead Info sheet
    var leadId = addLeadToSheet(leadData);
    console.log('Lead added to sheet with ID:', leadId);
    
    // Clean up temporary storage
    PropertiesService.getScriptProperties().deleteProperty('lead_' + phone);
    
    return leadId;
    
  } catch (error) {
    console.error('Error marking lead as verified:', error);
    return false;
  }
}

/**
 * Add verified lead to the Lead Info sheet with quiz answers
 */
function addLeadToSheet(leadData) {
  try {
    var spreadsheet = SpreadsheetApp.openById(SPREADSHEET_ID);
    var leadSheet = spreadsheet.getSheetByName(LEADS_SHEET_NAME);
    
    // Create Lead Info sheet if it doesn't exist
    if (!leadSheet) {
      leadSheet = spreadsheet.insertSheet(LEADS_SHEET_NAME);
      
      // Add comprehensive headers including quiz answers
      var headers = [
        'Lead ID', 'Timestamp', 'First Name', 'Last Name', 'Email', 'Phone',
        'Verification Code Used', 'Verified At', 'Status',
        'Q1: Age Range', 'Q2: Tobacco Use', 'Q3: Coverage Amount', 
        'Q4: Insurance Goal', 'Q5: Health Status', 'Q6: Coverage Timing'
      ];
      leadSheet.getRange(1, 1, 1, headers.length).setValues([headers]);
      
      // Format headers
      leadSheet.getRange(1, 1, 1, headers.length)
        .setFontWeight('bold')
        .setBackground('#1B365D')
        .setFontColor('white');
    }
    
    // Generate unique lead ID
    var leadId = 'SP' + Date.now();
    
    // Extract quiz answers from stored data
    var quizAnswers = leadData.quizAnswers || {};
    
    // Prepare row data with quiz answers
    var rowData = [
      leadId,
      new Date(leadData.timestamp),
      leadData.firstName,
      leadData.lastName,
      leadData.email,
      leadData.phone,
      leadData.verificationCode,
      new Date(leadData.verifiedAt),
      'Verified Lead',
      quizAnswers.q1 || '', // Age Range
      quizAnswers.q2 || '', // Tobacco Use  
      quizAnswers.q3 || '', // Coverage Amount
      quizAnswers.q4 || '', // Insurance Goal
      quizAnswers.q5 || '', // Health Status
      quizAnswers.q6 || ''  // Coverage Timing
    ];
    
    // Add row to sheet
    leadSheet.appendRow(rowData);
    
    // Auto-resize columns for better readability
    leadSheet.autoResizeColumns(1, rowData.length);
    
    console.log('Lead successfully added to sheet:', leadId);
    return leadId;
    
  } catch (error) {
    console.error('Error adding lead to sheet:', error);
    throw error;
  }
}

/**
 * Create response for form submissions
 */
function createFormResponse(success, message) {
  // For form submissions, we return HTML since the form expects a page response
  var html = HtmlService.createHtmlOutput(`
    <!DOCTYPE html>
    <html>
    <head>
      <title>Silver Path Network - Response</title>
      <style>
        body { font-family: Arial, sans-serif; text-align: center; padding: 50px; }
        .success { color: #28a745; }
        .error { color: #dc3545; }
      </style>
    </head>
    <body>
      <h2>Silver Path Network</h2>
      <p class="${success ? 'success' : 'error'}">${message}</p>
      <p><small>This window can be closed.</small></p>
    </body>
    </html>
  `);
  
  return html;
}

/**
 * Test function for development
 */
function testVerificationFlow() {
  var testParams = {
    firstName: 'Test',
    lastName: 'User',
    email: 'test@example.com',
    phone: '5551234567',
    verificationCode: '123456'
  };
  
  console.log('Testing verification flow...');
  var result = handleVerificationRequest(testParams);
  console.log('Result:', result);
}

/**
 * Cleanup function to remove old temporary lead data
 */
function cleanupOldLeadData() {
  var properties = PropertiesService.getScriptProperties().getProperties();
  var now = new Date();
  var maxAge = 24 * 60 * 60 * 1000; // 24 hours in milliseconds
  
  for (var key in properties) {
    if (key.startsWith('lead_')) {
      try {
        var leadData = JSON.parse(properties[key]);
        var leadTime = new Date(leadData.timestamp);
        
        if (now - leadTime > maxAge) {
          PropertiesService.getScriptProperties().deleteProperty(key);
          console.log('Cleaned up old lead data:', key);
        }
      } catch (error) {
        // Invalid data, clean it up
        PropertiesService.getScriptProperties().deleteProperty(key);
      }
    }
  }
}