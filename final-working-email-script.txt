function doGet(e) {
  console.log('GET request received');
  var params = e.parameter;
  console.log('GET parameters:', JSON.stringify(params));
  return handleRequest(params);
}

function doPost(e) {
  console.log('POST request received');
  var params = e.parameter;
  console.log('POST parameters:', JSON.stringify(params));
  return handleRequest(params);
}

function handleRequest(params) {
  try {
    console.log('=== PROCESSING REQUEST ===');
    console.log('All received parameters:', JSON.stringify(params));
    
    // Check if we have the minimum required data
    if (params.firstName && params.lastName && params.phone) {
      console.log('=== REQUIRED DATA PRESENT - SENDING EMAIL ===');
      
      var firstName = params.firstName;
      var lastName = params.lastName;
      var email = params.email || 'No email provided';
      var phone = params.phone;
      var code = params.verificationCode || Math.floor(100000 + Math.random() * 900000).toString();
      var quizType = params.quizId === 'arizona-final-expense-quiz-2' ? 'Arizona Quiz' : 'Standard Quiz';
      
      console.log('Processing lead:', firstName, lastName, 'Code:', code);
      
      // Create email content
      var subject = 'Silver Path Network - ' + quizType + ' - NEW LEAD: ' + firstName + ' ' + lastName;
      var emailBody = '';
      emailBody += 'NEW LEAD VERIFICATION REQUEST\n';
      emailBody += '================================\n\n';
      emailBody += 'LEAD DETAILS:\n';
      emailBody += 'Name: ' + firstName + ' ' + lastName + '\n';
      emailBody += 'Email: ' + email + '\n';
      emailBody += 'Phone: ' + phone + '\n';
      emailBody += 'Quiz Type: ' + quizType + '\n';
      emailBody += 'Verification Code: ' + code + '\n';
      emailBody += 'Timestamp: ' + new Date().toString() + '\n\n';
      emailBody += 'TEXT MESSAGE TO SEND:\n';
      emailBody += '================================\n';
      emailBody += 'Hi ' + firstName + ', Thank you for choosing Silver Path Network. Your verification code is ' + code + '\n\n';
      emailBody += 'NEXT STEPS:\n';
      emailBody += '1. Send the above text message to: ' + phone + '\n';
      emailBody += '2. Customer will enter code on website to verify\n';
      emailBody += '3. Once verified, full details will be saved to Google Sheets\n\n';
      emailBody += 'Generated by Silver Path Network Lead System';
      
      // Send email
      try {
        console.log('Attempting to send email to: ajboyd96@gmail.com');
        GmailApp.sendEmail('ajboyd96@gmail.com', subject, emailBody);
        console.log('SUCCESS: Email sent successfully to ajboyd96@gmail.com');
        
        return HtmlService.createHtmlOutput(
          '<h2>Silver Path Network</h2>' +
          '<p style="color: green;">✅ Verification code sent successfully!</p>' +
          '<p>Check your email for lead details and SMS instructions.</p>'
        );
        
      } catch (emailError) {
        console.error('EMAIL SEND ERROR:', emailError);
        console.error('Email error details:', emailError.toString());
        
        return HtmlService.createHtmlOutput(
          '<h2>Silver Path Network</h2>' +
          '<p style="color: red;">❌ Email sending failed: ' + emailError.message + '</p>'
        );
      }
      
    } else {
      console.log('MISSING REQUIRED FIELDS');
      console.log('firstName:', params.firstName ? 'present' : 'MISSING');
      console.log('lastName:', params.lastName ? 'present' : 'MISSING');
      console.log('phone:', params.phone ? 'present' : 'MISSING');
      
      return HtmlService.createHtmlOutput(
        '<h2>Silver Path Network</h2>' +
        '<p style="color: orange;">⚠️ Missing required contact information</p>'
      );
    }
    
  } catch (mainError) {
    console.error('MAIN PROCESSING ERROR:', mainError);
    console.error('Main error details:', mainError.toString());
    
    return HtmlService.createHtmlOutput(
      '<h2>Silver Path Network</h2>' +
      '<p style="color: red;">❌ Processing error: ' + mainError.message + '</p>'
    );
  }
}