var SPREADSHEET_ID = '1MZYgrMksEKzKksiXYf7B2dNnrzu9prScwbCZ0TWmIxc';
var CODES_SHEET_NAME = 'Sheet1';
var LEADS_SHEET_NAME = 'Lead Info';
var ARIZONA_SHEET_NAME = 'Arizona Quiz Responses';
var ADMIN_EMAIL = 'ajboyd96@gmail.com';

var TELEGRAM_BOT_TOKEN = '8037279353:AAHpV-yEVV3uWMPmfVuq_dKY3d1h_RBmUwA';
var TELEGRAM_CHAT_ID = '7463862813';

function doGet(e) {
  return ContentService
    .createTextOutput('Silver Path Network SMS Verification API is running')
    .setMimeType(ContentService.MimeType.TEXT);
}

function doPost(e) {
  try {
    console.log('=== RECEIVED POST REQUEST ===');
    var params = e.parameter;
    console.log('Full parameter dump:', JSON.stringify(params));
    
    if (params.action === 'submit_lead') {
      console.log('Processing quiz data submission');
      return handleQuizDataSubmission(params);
    }

    if (params.resend === 'true') {
      console.log('Processing resend request');
      return handleVerificationRequest(params);
    }

    if (params.firstName && params.lastName && params.email && params.phone && !params.action) {
      console.log('Processing verification code request');
      return handleVerificationRequest(params);
    }

    if (params.firstName || params.lastName || params.email || params.phone) {
      console.log('Received contact info but missing some fields:');
      console.log('- firstName:', params.firstName ? 'present' : 'missing');
      console.log('- lastName:', params.lastName ? 'present' : 'missing');
      console.log('- email:', params.email ? 'present' : 'missing');
      console.log('- phone:', params.phone ? 'present' : 'missing');
      
      if (params.firstName && params.lastName && params.email && params.phone) {
        console.log('Processing verification code request (fallback)');
        return handleVerificationRequest(params);
      }
    }

    console.warn('Invalid request - no matching handler');
    console.warn('Available parameters:', Object.keys(params));
    return createFormResponse(false, 'Invalid request parameters');

  } catch (error) {
    console.error('Error in doPost:', error);
    return createFormResponse(false, 'Server error occurred: ' + error.message);
  }
}

function handleVerificationRequest(params) {
  try {
    var firstName = params.firstName;
    var lastName = params.lastName;
    var email = params.email;
    var phone = params.phone;
    var verificationCode = params.verificationCode;
    var quizId = params.quizId || 'standard-quiz';

    var quizType = quizId === 'arizona-final-expense-quiz-2' ? 'Arizona Quiz' : 'Standard Quiz';
    var code = verificationCode || Math.floor(100000 + Math.random() * 900000).toString();
    var cleanPhone = phone.replace(/\D/g, '');
    if (cleanPhone.length === 11 && cleanPhone.startsWith('1')) {
      cleanPhone = cleanPhone.substring(1);
    }

    var isResend = params.resend === 'true';
    var subject = 'Silver Path Network - ' + quizType + ' - ' + (isResend ? 'RESEND CODE' : 'New Lead') + ': ' + firstName + ' ' + lastName;
    var body = (isResend ? 'RESEND CODE request for existing lead:\n\n' : 'New lead verification request:\n\n');
    body += '=== TEXT MESSAGE TO SEND ===\n';
    body += 'Hi ' + firstName + ', Thank you for choosing Silver Path Network. Your code is ' + code + '\n\n';
    body += '=== LEAD INFORMATION ===\n';
    body += 'Name: ' + firstName + ' ' + lastName + '\n';
    body += 'Email: ' + email + '\n';
    body += 'Phone: ' + cleanPhone + '\n';
    body += 'Quiz Type: ' + quizType + '\n';
    body += 'Verification Code: ' + code + '\n';
    body += 'Request Type: ' + (isResend ? 'Resend Code' : 'New Lead') + '\n';
    body += 'Timestamp: ' + new Date().toLocaleString() + '\n\n';
    body += '=== INSTRUCTIONS ===\n';
    body += '1. Text the above message to the lead at their phone number\n';
    body += '2. They will enter this code on the website to verify\n';
    body += '3. Once verified, their complete information will be added to the appropriate sheet\n\n';
    body += 'Generated by Silver Path Network System';

    try {
      GmailApp.sendEmail(ADMIN_EMAIL, subject, body);
      console.log('Email sent to admin');
    } catch (e) {
      console.error('Error sending email:', e.message);
    }

    var telegramMessage = 'New ' + quizType + ' Lead Alert!\n\n' +
      'Name: ' + firstName + ' ' + lastName + '\n' +
      'Email: ' + email + '\n' +
      'Phone: ' + cleanPhone + '\n' +
      'Code: ' + code + '\n' +
      'Quiz: ' + quizType + '\n\n' +
      'Text this to lead:\n' +
      'Hi ' + firstName + ', Thank you for choosing Silver Path Network. Your code is ' + code;

    try {
      var result = sendTelegramMessage(telegramMessage);
      console.log('Telegram result:', result);
    } catch (e) {
      console.error('Telegram message failed:', e.message);
    }

    var leadData = {
      firstName: firstName,
      lastName: lastName,
      email: email,
      phone: cleanPhone,
      verificationCode: code,
      quizId: quizId,
      timestamp: new Date().toISOString(),
      verified: false
    };

    PropertiesService.getScriptProperties().setProperty('lead_' + cleanPhone, JSON.stringify(leadData));
    console.log('Lead data stored for phone:', cleanPhone);

    return createFormResponse(true, 'Verification code sent successfully');

  } catch (error) {
    console.error('Error in handleVerificationRequest:', error);
    return createFormResponse(false, 'Failed to send verification code: ' + error.message);
  }
}

function handleQuizDataSubmission(params) {
  try {
    console.log('=== QUIZ DATA SUBMISSION ===');
    
    var phone = params.phone;
    var quizAnswersJson = params.quizAnswers;
    var firstName = params.firstName;
    var lastName = params.lastName;
    var email = params.email;
    var quizId = params.quizId || 'standard-quiz';
    
    if (!phone) {
      console.log('Missing phone number');
      return createFormResponse(false, 'Phone number required');
    }
    
    if (!quizAnswersJson) {
      console.log('Missing quiz answers');
      return createFormResponse(false, 'Quiz answers required');
    }
    
    var leadJson = PropertiesService.getScriptProperties().getProperty('lead_' + phone);
    var leadData;
    
    if (leadJson) {
      console.log('Found stored lead data');
      leadData = JSON.parse(leadJson);
    } else {
      console.log('No stored lead data found, creating from submitted data');
      leadData = {
        firstName: firstName,
        lastName: lastName,
        email: email,
        phone: phone,
        verificationCode: 'VERIFIED',
        quizId: quizId,
        timestamp: new Date().toISOString(),
        verified: false
      };
    }
    
    leadData.verified = true;
    leadData.verifiedAt = new Date().toISOString();
    
    try {
      leadData.quizAnswers = JSON.parse(quizAnswersJson);
      console.log('Parsed quiz answers:', leadData.quizAnswers);
    } catch (parseError) {
      console.error('Error parsing quiz answers:', parseError);
      leadData.quizAnswers = {};
    }
    
    var leadId;
    if (quizId === 'arizona-final-expense-quiz-2') {
      leadId = addArizonaLeadToSheet(leadData);
      console.log('Arizona lead added to sheet with ID:', leadId);
    } else {
      leadId = addLeadToSheet(leadData);
      console.log('Standard lead added to sheet with ID:', leadId);
    }
    
    if (leadJson) {
      PropertiesService.getScriptProperties().deleteProperty('lead_' + phone);
      console.log('Cleaned up temporary storage');
    }
    
    return createFormResponse(true, 'Lead data saved successfully to Google Sheets');
    
  } catch (error) {
    console.error('Error handling quiz data submission:', error);
    return createFormResponse(false, 'Failed to save lead data: ' + error.message);
  }
}

function addArizonaLeadToSheet(leadData) {
  try {
    console.log('=== ADDING ARIZONA LEAD TO SHEET ===');
    
    var spreadsheet = SpreadsheetApp.openById(SPREADSHEET_ID);
    var leadSheet = spreadsheet.getSheetByName(ARIZONA_SHEET_NAME);
    
    if (!leadSheet) {
      console.log('Creating new Arizona Quiz Responses sheet');
      leadSheet = spreadsheet.insertSheet(ARIZONA_SHEET_NAME);
      
      var headers = [
        'Lead ID', 'Date Submitted', 'Time Submitted',
        'First Name', 'Last Name', 'Email Address', 'Phone Number',
        'Verification Code', 'Verification Status', 'Verified Date/Time',
        'Q1: Age', 'Q2: Arizona Resident', 'Q3: US Citizen', 'Q4: Existing Policy', 
        'Q5: Marital Status', 'Q6: Children/Grandchildren', 'Q7: Tobacco Use', 
        'Q8: Health Conditions', 'Q9: Hospitalized', 'Q10: Medications', 
        'Q11: Overall Health', 'Q12: Funeral Costs Knowledge', 'Q13: Family Prepared', 
        'Q14: Coverage Priority', 'Q15: Burial/Cremation', 'Q16: Timeline', 
        'Q17: View Plans', 'Q18: Contact Preference', 'Q19: Best Time', 'Q20: Arizona Zip'
      ];
      
      leadSheet.getRange(1, 1, 1, headers.length).setValues([headers]);
      var headerRange = leadSheet.getRange(1, 1, 1, headers.length);
      headerRange.setFontWeight('bold')
                 .setBackground('#1B365D')
                 .setFontColor('white')
                 .setFontSize(11)
                 .setHorizontalAlignment('center');
      
      console.log('Created Arizona sheet with headers');
    }
    
    var leadId = 'AZ' + Date.now();
    var quizAnswers = leadData.quizAnswers || {};
    var submissionDate = new Date(leadData.timestamp);
    var verifiedDate = new Date(leadData.verifiedAt);
    
    var rowData = [
      leadId,
      Utilities.formatDate(submissionDate, 'America/New_York', 'MM/dd/yyyy'),
      Utilities.formatDate(submissionDate, 'America/New_York', 'HH:mm:ss'),
      leadData.firstName,
      leadData.lastName,
      leadData.email,
      leadData.phone,
      leadData.verificationCode,
      'Verified',
      Utilities.formatDate(verifiedDate, 'America/New_York', 'MM/dd/yyyy HH:mm:ss'),
      quizAnswers.q1 || 'Not answered',
      quizAnswers.q2 || 'Not answered',
      quizAnswers.q3 || 'Not answered',
      quizAnswers.q4 || 'Not answered',
      quizAnswers.q5 || 'Not answered',
      quizAnswers.q6 || 'Not answered',
      quizAnswers.q7 || 'Not answered',
      quizAnswers.q8 || 'Not answered',
      quizAnswers.q9 || 'Not answered',
      quizAnswers.q10 || 'Not answered',
      quizAnswers.q11 || 'Not answered',
      quizAnswers.q12 || 'Not answered',
      quizAnswers.q13 || 'Not answered',
      quizAnswers.q14 || 'Not answered',
      quizAnswers.q15 || 'Not answered',
      quizAnswers.q16 || 'Not answered',
      quizAnswers.q17 || 'Not answered',
      quizAnswers.q18 || 'Not answered',
      quizAnswers.q19 || 'Not answered',
      quizAnswers.q20 || 'Not answered'
    ];
    
    leadSheet.appendRow(rowData);
    leadSheet.autoResizeColumns(1, rowData.length);
    
    console.log('Arizona lead successfully added to sheet:', leadId);
    return leadId;
    
  } catch (error) {
    console.error('Error adding Arizona lead to sheet:', error);
    throw error;
  }
}

function addLeadToSheet(leadData) {
  try {
    console.log('=== ADDING STANDARD LEAD TO SHEET ===');
    
    var spreadsheet = SpreadsheetApp.openById(SPREADSHEET_ID);
    var leadSheet = spreadsheet.getSheetByName(LEADS_SHEET_NAME);
    
    if (!leadSheet) {
      console.log('Creating new Lead Info sheet');
      leadSheet = spreadsheet.insertSheet(LEADS_SHEET_NAME);
      
      var headers = [
        'Lead ID', 'Date Submitted', 'Time Submitted',
        'First Name', 'Last Name', 'Email Address', 'Phone Number',
        'Verification Code', 'Verification Status', 'Verified Date/Time',
        'Age Range', 'Tobacco Use', 'Desired Coverage Amount', 
        'Primary Insurance Goal', 'Health Status', 'When Coverage Needed'
      ];
      
      leadSheet.getRange(1, 1, 1, headers.length).setValues([headers]);
      var headerRange = leadSheet.getRange(1, 1, 1, headers.length);
      headerRange.setFontWeight('bold')
                 .setBackground('#1B365D')
                 .setFontColor('white')
                 .setFontSize(11)
                 .setHorizontalAlignment('center');
      
      console.log('Created standard sheet with headers');
    }
    
    var leadId = 'SP' + Date.now();
    var quizAnswers = leadData.quizAnswers || {};
    var submissionDate = new Date(leadData.timestamp);
    var verifiedDate = new Date(leadData.verifiedAt);
    
    var rowData = [
      leadId,
      Utilities.formatDate(submissionDate, 'America/New_York', 'MM/dd/yyyy'),
      Utilities.formatDate(submissionDate, 'America/New_York', 'HH:mm:ss'),
      leadData.firstName,
      leadData.lastName,
      leadData.email,
      leadData.phone,
      leadData.verificationCode,
      'Verified',
      Utilities.formatDate(verifiedDate, 'America/New_York', 'MM/dd/yyyy HH:mm:ss'),
      quizAnswers.q1 || 'Not answered',
      quizAnswers.q2 || 'Not answered',
      quizAnswers.q3 || 'Not answered',
      quizAnswers.q4 || 'Not answered',
      quizAnswers.q5 || 'Not answered',
      quizAnswers.q6 || 'Not answered'
    ];
    
    leadSheet.appendRow(rowData);
    leadSheet.autoResizeColumns(1, rowData.length);
    
    console.log('Lead successfully added to sheet:', leadId);
    return leadId;
    
  } catch (error) {
    console.error('Error adding lead to sheet:', error);
    throw error;
  }
}

function handleResendRequest(params) {
  try {
    console.log('Handling resend request');
    return handleVerificationRequest(params);
  } catch (error) {
    console.error('Error handling resend request:', error);
    return createFormResponse(false, 'Failed to resend verification code: ' + error.message);
  }
}

function sendTelegramMessage(message) {
  var telegramUrl = 'https://api.telegram.org/bot' + TELEGRAM_BOT_TOKEN + '/sendMessage';
  var payload = {
    chat_id: TELEGRAM_CHAT_ID,
    text: message
  };

  var options = {
    method: 'POST',
    headers: {
      'Content-Type': 'application/json'
    },
    payload: JSON.stringify(payload)
  };

  var response = UrlFetchApp.fetch(telegramUrl, options);
  var result = response.getContentText();
  console.log('Telegram API raw response:', result);
  var responseData = JSON.parse(result);

  if (responseData.ok) {
    return 'Message sent';
  } else {
    throw new Error(responseData.description);
  }
}

function createFormResponse(success, message) {
  var htmlContent = '<!DOCTYPE html>' +
    '<html>' +
    '<head>' +
    '<title>Silver Path Network - Response</title>' +
    '<style>' +
    'body { font-family: Arial, sans-serif; text-align: center; padding: 50px; background: #f5f5f5; }' +
    '.container { background: white; padding: 30px; border-radius: 10px; max-width: 500px; margin: 0 auto; box-shadow: 0 2px 10px rgba(0,0,0,0.1); }' +
    '.success { color: #28a745; font-size: 18px; margin: 20px 0; }' +
    '.error { color: #dc3545; font-size: 18px; margin: 20px 0; }' +
    'h2 { color: #1B365D; margin-bottom: 20px; }' +
    '</style>' +
    '</head>' +
    '<body>' +
    '<div class="container">' +
    '<h2>Silver Path Network</h2>' +
    '<p class="' + (success ? 'success' : 'error') + '">' + message + '</p>' +
    '<p><small>This window can be closed.</small></p>' +
    '</div>' +
    '</body>' +
    '</html>';

  return HtmlService.createHtmlOutput(htmlContent);
}