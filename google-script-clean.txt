var SPREADSHEET_ID = '1MZYgrMksEKzKksiXYf7B2dNnrzu9prScwbCZ0TWmIxc';
var CODES_SHEET_NAME = 'Sheet1';
var LEADS_SHEET_NAME = 'Lead Info';
var ARIZONA_SHEET_NAME = 'Arizona Quiz Responses';
var ADMIN_EMAIL = 'ajboyd96@gmail.com';

var TELEGRAM_BOT_TOKEN = '8037279353:AAHpV-yEVV3uWMPmfVuq_dKY3d1h_RBmUwA';
var TELEGRAM_CHAT_ID = '7463862813';

function doGet(e) {
  return ContentService
    .createTextOutput('Silver Path Network SMS Verification API is running')
    .setMimeType(ContentService.MimeType.TEXT);
}

function doPost(e) {
  try {
    console.log('=== RECEIVED POST REQUEST ===');
    console.log('Request parameters:', e.parameter);
    console.log('Parameter keys:', Object.keys(e.parameter));
    
    var params = e.parameter;
    
    console.log('firstName:', params.firstName);
    console.log('lastName:', params.lastName);
    console.log('email:', params.email);
    console.log('phone:', params.phone);
    console.log('action:', params.action);
    console.log('resend:', params.resend);
    console.log('quizId:', params.quizId);
    
    if (params.action === 'submit_lead') {
      console.log('Processing quiz data submission');
      return handleQuizDataSubmission(params);
    }
    
    if (params.resend === 'true') {
      console.log('Processing resend request');
      return handleResendRequest(params);
    }
    
    if (params.firstName && params.lastName && params.email && params.phone && !params.action) {
      console.log('Processing verification code request');
      return handleVerificationRequest(params);
    }
    
    if (params.firstName || params.lastName || params.email || params.phone) {
      console.log('Received contact info but missing some fields:');
      console.log('- firstName:', params.firstName ? 'present' : 'missing');
      console.log('- lastName:', params.lastName ? 'present' : 'missing');
      console.log('- email:', params.email ? 'present' : 'missing');
      console.log('- phone:', params.phone ? 'present' : 'missing');
      
      if (params.firstName && params.lastName && params.email && params.phone) {
        console.log('Processing verification code request (fallback)');
        return handleVerificationRequest(params);
      }
    }
    
    console.log('Invalid request - no matching handler');
    console.log('Available parameters:', Object.keys(params));
    return createFormResponse(false, 'Invalid request parameters');
    
  } catch (error) {
    console.error('Error in doPost:', error);
    return createFormResponse(false, 'Server error occurred: ' + error.message);
  }
}

function handleVerificationRequest(params) {
  try {
    var firstName = params.firstName;
    var lastName = params.lastName;
    var email = params.email;
    var phone = params.phone;
    var verificationCode = params.verificationCode;
    var quizId = params.quizId || 'standard-quiz';
    
    var quizType = quizId === 'arizona-final-expense-quiz-2' ? 'Arizona Quiz' : 'Standard Quiz';
    
    var code = verificationCode || Math.floor(100000 + Math.random() * 900000).toString();
    console.log('Using verification code:', code);
    console.log('Quiz type:', quizType);
    
    var cleanPhone = phone.replace(/\D/g, '');
    if (cleanPhone.length === 11 && cleanPhone.startsWith('1')) {
      cleanPhone = cleanPhone.substring(1);
    }
    console.log('Normalized phone:', cleanPhone);
    
    var isResend = params.resend === 'true';
    
    var subject = 'Silver Path Network - ' + quizType + ' - ' + (isResend ? 'RESEND CODE' : 'New Lead') + ': ' + firstName + ' ' + lastName;
    var body = (isResend ? 'RESEND CODE request for existing lead:\n\n' : 'New lead verification request:\n\n');
    body += '=== TEXT MESSAGE TO SEND ===\n';
    body += 'Hi ' + firstName + ', Thank you for choosing Silver Path Network. Your code is ' + code + '\n\n';
    body += '=== LEAD INFORMATION ===\n';
    body += 'Name: ' + firstName + ' ' + lastName + '\n';
    body += 'Email: ' + email + '\n';
    body += 'Phone: ' + cleanPhone + '\n';
    body += 'Quiz Type: ' + quizType + '\n';
    body += 'Verification Code: ' + code + '\n';
    body += 'Request Type: ' + (isResend ? 'Resend Code' : 'New Lead') + '\n';
    body += 'Timestamp: ' + new Date().toLocaleString() + '\n\n';
    body += '=== INSTRUCTIONS ===\n';
    body += '1. Text the above message to the lead at their phone number\n';
    body += '2. They will enter this code on the website to verify\n';
    body += '3. Once verified, their complete information will be added to the appropriate sheet\n\n';
    body += 'Generated by Silver Path Network System';
    
    GmailApp.sendEmail(ADMIN_EMAIL, subject, body);
    console.log('Email sent to admin with verification code');
    
    var telegramMessage = 'New ' + quizType + ' Lead Alert!\n\n' +
      'Name: ' + firstName + ' ' + lastName + '\n' +
      'Email: ' + email + '\n' +
      'Phone: ' + cleanPhone + '\n' +
      'Code: ' + code + '\n' +
      'Quiz: ' + quizType + '\n\n' +
      'Text this to lead:\n' +
      'Hi ' + firstName + ', Thank you for choosing Silver Path Network. Your code is ' + code;
    
    sendTelegramMessage(telegramMessage);
    console.log('Telegram notification sent');
    
    var leadData = {
      firstName: firstName,
      lastName: lastName,
      email: email,
      phone: cleanPhone,
      verificationCode: code,
      quizId: quizId,
      timestamp: new Date().toISOString(),
      verified: false
    };
    
    PropertiesService.getScriptProperties().setProperty('lead_' + cleanPhone, JSON.stringify(leadData));
    console.log('Lead data stored for phone:', cleanPhone);
    
    return createFormResponse(true, 'Verification code sent successfully');
    
  } catch (error) {
    console.error('Error handling verification request:', error);
    return createFormResponse(false, 'Failed to send verification code: ' + error.message);
  }
}

function handleResendRequest(params) {
  try {
    console.log('Handling resend request');
    return handleVerificationRequest(params);
  } catch (error) {
    console.error('Error handling resend request:', error);
    return createFormResponse(false, 'Failed to resend verification code: ' + error.message);
  }
}

function sendTelegramMessage(message) {
  try {
    var telegramUrl = 'https://api.telegram.org/bot' + TELEGRAM_BOT_TOKEN + '/sendMessage';
    
    var payload = {
      'chat_id': TELEGRAM_CHAT_ID,
      'text': message
    };
    
    var options = {
      'method': 'POST',
      'headers': {
        'Content-Type': 'application/json'
      },
      'payload': JSON.stringify(payload)
    };
    
    var response = UrlFetchApp.fetch(telegramUrl, options);
    var responseData = JSON.parse(response.getContentText());
    
    if (responseData.ok) {
      console.log('Telegram message sent successfully');
      return true;
    } else {
      console.error('Telegram API error:', responseData.description);
      return false;
    }
    
  } catch (error) {
    console.error('Error sending Telegram message:', error);
    return false;
  }
}

function createFormResponse(success, message) {
  var htmlContent = '<!DOCTYPE html>' +
    '<html>' +
    '<head>' +
    '<title>Silver Path Network - Response</title>' +
    '<style>' +
    'body { font-family: Arial, sans-serif; text-align: center; padding: 50px; background: #f5f5f5; }' +
    '.container { background: white; padding: 30px; border-radius: 10px; max-width: 500px; margin: 0 auto; box-shadow: 0 2px 10px rgba(0,0,0,0.1); }' +
    '.success { color: #28a745; font-size: 18px; margin: 20px 0; }' +
    '.error { color: #dc3545; font-size: 18px; margin: 20px 0; }' +
    'h2 { color: #1B365D; margin-bottom: 20px; }' +
    '</style>' +
    '</head>' +
    '<body>' +
    '<div class="container">' +
    '<h2>Silver Path Network</h2>' +
    '<p class="' + (success ? 'success' : 'error') + '">' + message + '</p>' +
    '<p><small>This window can be closed.</small></p>' +
    '</div>' +
    '</body>' +
    '</html>';
  
  var html = HtmlService.createHtmlOutput(htmlContent);
  return html;
}